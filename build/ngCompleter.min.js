angular.module("ngCompleter",[]).directive("completer",function(){"use strict";return{restrict:"AE",scope:{itemTag:"@",source:"=",selectedClass:"@",completerModel:"=ngModel",separator:"@",suggest:"@",template:"@",zIndex:"@",filter:"&"},link:function(e,t,o){function n(){$||($=!0,t.on("keydown",a),t.on("keyup",c),x.on("mousedown",u),x.on("mouseover",i))}function l(){$&&($=!1,t.off("keydown"),t.off("keyup"),x.off("mousedown"),x.off("mouseover")),x.css("display","none")}function a(e){var t=e.keyCode||e.which||e.charCode;13===t&&(e.stopPropagation(),e.preventDefault())}function c(t){var o=t.keyCode||t.which||t.charCode;13===o||38===o||40===o?e.toggle(o):e.complete()}function r(t){var o=e.selectedClass;console.log(e.$complete.children()),console.log(e.$complete.children().find("."+o));var n=e.$complete.children().find("."+o);switch(console.log(n),console.log(111),t){case 40:n.removeClass(o),n=angular.element(n.next()[0]),console.log(n);break;case 38:n.removeClass(o),n=n.prev();break;case 13:p(n.text())}if(0===n.length){var l=e.$complete.children(e.itemTag);40===t?angular.element(l[0]):angular.element(l[l.length-1])}console.log(n),n.addClass(o)}function s(){var o=t.val().toString();return""===o?void e.$complete.css("display","none"):void(e.suggest?g(o):f(o))}function i(t){var o=e.selectedClass,n=angular.element(t.target),l=t.target.localName;l===e.itemTag&&(n.parent().find("."+o).removeClass(o),n.addClass(o))}function u(e){e.stopPropagation(),e.preventDefault(),console.log(angular.element(e.target).text()),p(angular.element(e.target).text())}function p(t){e.$apply(function(){e.completerModel=t}),e.$complete.css("display","none")}function g(t){var o=new RegExp(v(t),"i"),n=[];angular.forEach(e.source,function(e){o.test(e)&&n.push(e)}),n.sort(function(e,o){return e.indexOf(t)-o.indexOf(t)}),angular.forEach(n,function(e,t){n[t]=d(e)}),m(n.join(""))}function f(t){var o,n,l=e.separator,a=e.regexp,c=a?t.match(a):null,r=[],s=[];c&&(c=c[0],t=t.replace(a,""),o=new RegExp("^"+v(c),"i")),angular.forEach(e.source,function(e){e=l+e,n=d(t+e),o&&o.test(e)?r.push(n):s.push(n)}),r=r.length?r.sort():s,m(r.join(""))}function d(t){var o=e.itemTag;return"<"+o+">"+t+"</"+o+">"}function m(t){e.$complete.empty(),t?(e.$complete.html(t),console.log(e.$complete.children([":first-child"])),e.$complete.css("display","block")):e.$complete.css("display","none")}function h(e){return"string"==typeof e&&""!==e?(e=v(e),new RegExp(e+"+[^"+e+"]*$","i")):null}function v(e){return e.replace(/([\.\$\^\{\[\(\|\)\*\+\?\\])/g,"\\$1")}e.itemTag=e.itemTag||"li",e.source=e.source||[],e.suggest=e.suggest||!1,e.selectedClass=e.selectedClass||"completer-selected",e.template=e.template||'<ul class="completer-container"></ul>',e.zIndex=e.zIndex||600,t.attr("autocomplete","off"),t.after(e.template),e.$complete=t.next();var x=t.next(),$=!1,y={width:t[0].offsetWidth+"px",zIndex:e.zIndex,display:"none"};x.css(y),e.regexp=h(e.separator),e.toggle=r,e.complete=s,t.on("focus",n),t.on("blur",l)}}});