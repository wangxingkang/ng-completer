"use strict";angular.module("ngCompleter",[]).directive("ngCompleter",function(){return{restrict:"AE",scope:{itemTag:"@",source:"=",selectedClass:"@",completerModel:"=ngModel",separator:"@",suggest:"@",template:"@",zIndex:"@",filter:"&"},link:function(e,t){function n(){x||(x=!0,t.on({keydown:a,keyup:r}),C.on({mousedown:u,mouseover:i}))}function o(){x&&(x=!1,t.off("keydown"),t.off("keyup"),C.off("mousedown"),C.off("mouseover")),l(!1)}function a(e){var t=e.keyCode||e.which||e.charCode;13===t&&(e.stopPropagation(),e.preventDefault())}function r(t){var n=t.keyCode||t.which||t.charCode;13===n||38===n||40===n?e.toggle(n):e.complete()}function l(e){e?C.css("display","block"):C.css("display","none")}function s(t){var n=e.selectedClass,o=C.find("."+n);switch(t){case 40:o.removeClass(n),o=angular.element(o.next());break;case 38:o.removeClass(n),o=o.prev();break;case 13:f(o.text())}if(0===o.length){var a=C.children(e.itemTag);40===t?angular.element(a[0]):angular.element(a[a.length-1]),o=C.children(40===t?":first":":last")}o.addClass(n)}function c(){var n=t.val().toString();return""===n?void l(!1):void(e.suggest?g(n):p(n))}function i(t){var n=e.selectedClass,o=angular.element(t.target),a=t.target.localName;a===e.itemTag&&(o.parent().find("."+n).removeClass(n),o.addClass(n))}function u(e){e.stopPropagation(),e.preventDefault(),f(angular.element(e.target).text())}function f(t){e.$apply(function(){e.completerModel=t}),l(!1)}function g(t){var n=new RegExp(v(t),"i"),o=[];angular.forEach(e.source,function(e){n.test(e)&&o.push(e)}),o.sort(function(e,n){return e.indexOf(t)-n.indexOf(t)}),angular.forEach(o,function(e,t){o[t]=d(e)}),m(o.join(""))}function p(t){var n,o,a=e.separator,r=e.regexp,l=r?t.match(r):null,s=[],c=[];l&&(l=l[0],t=t.replace(r,""),n=new RegExp("^"+v(l),"i")),angular.forEach(e.source,function(e){e=a+e,o=d(t+e),n&&n.test(e)?s.push(o):c.push(o)}),s=s.length?s.sort():c,m(s.join(""))}function d(t){var n=e.itemTag;return"<"+n+">"+t+"</"+n+">"}function m(t){C.empty(),t?(C.html(t),C.children(":first-child").toggleClass(e.selectedClass),l(!0)):l(!1)}function h(e){return"string"==typeof e&&""!==e?(e=v(e),new RegExp(e+"+[^"+e+"]*$","i")):null}function v(e){return e.replace(/([\.\$\^\{\[\(\|\)\*\+\?\\])/g,"\\$1")}e.itemTag=e.itemTag||"li",e.source=e.source||[],e.suggest=e.suggest||!1,e.selectedClass=e.selectedClass||"completer-selected",e.template=e.template||'<ul class="completer-container"></ul>',e.zIndex=e.zIndex||600,t.attr("autocomplete","off"),t.after(e.template);var C=t.next(),x=!1,y={width:t[0].offsetWidth+"px",zIndex:e.zIndex,display:"none"};C.css(y),e.regexp=h(e.separator),e.toggle=s,e.complete=c,t.on({focus:n,blur:o})}}});